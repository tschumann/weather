name: Deploy

on:
  workflow_dispatch:

jobs:
  deploy-weather:
    runs-on: windows-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # seems to already be installed but good to be sure
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0"

      # AWS SAM already seems to be installed on windows-latest and trying to install it again gives the not very helpful "Generic MSI Error" message
      - name: Verify SAM installation
        run: sam --version

      # -----------------------------
      # NuGet Cache
      # -----------------------------
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Run tests
        run: ./test.ps1

      # -----------------------------
      # SAM Build Cache
      # -----------------------------
      - name: Cache SAM build artifacts
        uses: actions/cache@v4
        with:
          path: .aws-sam/cache
          key: sam-${{ runner.os }}-${{ hashFiles('**/*') }}
          restore-keys: |
            sam-${{ runner.os }}-

      - name: Build solution
        run: sam build

      # deploy it (not really)
      # command line options at https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-cli-command-reference-sam-deploy.html
      # different environments would be handled by different profiles (probably an IAM user with associated key+secret in each account)
      - name: Deploy solution
        run: echo "sam deploy --profile default --region ap-southeast-2 --stack-name weather-function --template-file template.yml"
